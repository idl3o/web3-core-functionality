<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Streaming Player | Web3 Crypto Streaming Service</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="application/javascript"></script>
    <script src="assets/js/video-loader.js"></script>
    <style>
        .player-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #1a1a2e;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 ratio */
            height: 0;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .video-container video, .video-container .placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f0f1a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stream-info {
            padding: 1rem;
            background-color: #16213e;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        .stream-button {
            background-color: #4361ee;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .stream-button:hover {
            background-color: #3a56d4;
        }
        
        .stream-button:disabled {
            background-color: #45456a;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 4px;
        }
        
        .status.success {
            background-color: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
            color: #2ecc71;
        }
        
        .status.error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #f44336;
        }
        
        .status.info {
            background-color: rgba(41, 128, 185, 0.2);
            border: 1px solid #2980b9;
            color: #3498db;
        }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4361ee;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="navigation">
        <div class="container nav-container">
            <a href="/" class="logo">Web3 Crypto Streaming</a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#features">Features</a></li>
                    <li><a href="index.html#token">Token</a></li>
                    <li><a href="docs/">Docs</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Player Section -->
    <section class="section">
        <div class="container">
            <h1>Web3 Streaming Player</h1>
            <p>Experience decentralized content streaming powered by blockchain technology</p>
            
            <div class="player-container">
                <h2 id="content-title">Demo Content: Blockchain Basics</h2>
                <p id="content-creator">By: Team MODSIAS</p>
                
                <div class="video-container">
                    <div class="placeholder" id="player-placeholder">
                        <div id="unlock-message">Connect wallet to access streaming content</div>
                    </div>
                    <video id="video-player" controls style="display:none;">
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                
                <div class="wallet-section">
                    <div id="wallet-status" class="status info">Please connect your wallet</div>
                    <div class="controls">
                        <button id="connect-wallet" class="stream-button">Connect Wallet</button>
                        <button id="purchase-credits" class="stream-button" disabled>Purchase Credits (0.01 ETH)</button>
                    </div>
                </div>
                
                <div class="stream-info">
                    <h3>Streaming Access</h3>
                    <p>Content ID: <span id="content-id">content_001</span></p>
                    <p>Your Credits: <span id="credit-balance">0</span> STRM</p>
                    <p>Stream Status: <span id="stream-status">Not started</span></p>
                    <p>Time Remaining: <span id="time-remaining">-</span></p>
                    
                    <div class="controls">
                        <button id="start-stream" class="stream-button" disabled>Start Streaming (1 Credit)</button>
                        <button id="check-access" class="stream-button" disabled>Check Access</button>
                    </div>
                    
                    <div id="stream-message" class="status" style="display:none;"></div>
                    <div class="loader" id="transaction-loader"></div>
                </div>
                
                <!-- Content Selection (New) -->
                <div class="stream-info">
                    <h3>Demo Content Selection</h3>
                    <select id="content-selector" class="content-select">
                        <option value="content_001">Blockchain Basics</option>
                        <option value="content_002">Smart Contract Development</option>
                        <option value="content_003">Web3 Integration Guide</option>
                    </select>
                    <button id="load-content" class="stream-button">Load Content Info</button>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Video loader initialization
        const videoLoader = new VideoLoader();
        
        // Contract address - replace with your deployed contract
        const contractAddress = "0xYourContractAddressHere";
        
        // ABI for the StreamingToken contract
        const contractABI = [
            "function purchaseCredits() public payable",
            "function startStream(string memory contentId) public",
            "function canStream(address user, string memory contentId) public view returns (bool)",
            "function balanceOf(address account) public view returns (uint256)"
        ];
        
        // Get initial demo content
        const demoContent = videoLoader.getDemoContent('content_001');
        
        // Elements
        const connectWalletBtn = document.getElementById('connect-wallet');
        const purchaseCreditsBtn = document.getElementById('purchase-credits');
        const startStreamBtn = document.getElementById('start-stream');
        const checkAccessBtn = document.getElementById('check-access');
        const walletStatus = document.getElementById('wallet-status');
        const creditBalance = document.getElementById('credit-balance');
        const streamStatus = document.getElementById('stream-status');
        const timeRemaining = document.getElementById('time-remaining');
        const streamMessage = document.getElementById('stream-message');
        const transactionLoader = document.getElementById('transaction-loader');
        const videoPlayer = document.getElementById('video-player');
        const playerPlaceholder = document.getElementById('player-placeholder');
        const unlockMessage = document.getElementById('unlock-message');
        const contentSelector = document.getElementById('content-selector');
        const loadContentBtn = document.getElementById('load-content');
        
        let provider, signer, contract;
        let userAddress = null;
        let streamExpiryTime = 0;
        let accessTimer = null;
        
        // Content selection handler
        loadContentBtn.addEventListener('click', () => {
            const contentId = contentSelector.value;
            const content = videoLoader.getDemoContent(contentId);
            
            // Update UI
            document.getElementById('content-title').textContent = `Demo Content: ${content.title}`;
            document.getElementById('content-creator').textContent = `By: ${content.creator}`;
            document.getElementById('content-id').textContent = contentId;
            
            // Set placeholder background if available
            if (content.thumbnail) {
                playerPlaceholder.style.backgroundImage = `url('${content.thumbnail}')`;
                playerPlaceholder.style.backgroundSize = 'cover';
                playerPlaceholder.style.backgroundPosition = 'center';
            }
            
            // Reset stream status
            streamStatus.textContent = 'Not started';
            timeRemaining.textContent = '-';
            
            // Hide video player
            playerPlaceholder.style.display = 'flex';
            videoPlayer.style.display = 'none';
            
            // Show message
            streamMessage.style.display = 'block';
            streamMessage.textContent = `Content information updated. ${content.description}`;
            streamMessage.className = 'status info';
        });
        
        // Connect wallet
        connectWalletBtn.addEventListener('click', async () => {
            try {
                // Check if MetaMask is installed
                if (window.ethereum) {
                    // Show loader
                    transactionLoader.style.display = 'block';
                    
                    // Request account access
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // Initialize contract
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    
                    // Update UI
                    walletStatus.textContent = `Connected: ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}`;
                    walletStatus.className = 'status success';
                    
                    // Enable buttons
                    purchaseCreditsBtn.disabled = false;
                    checkAccessBtn.disabled = false;
                    
                    // Update credit balance
                    await updateCreditBalance();
                    
                    // Hide loader
                    transactionLoader.style.display = 'none';
                } else {
                    walletStatus.textContent = 'MetaMask not found. Please install MetaMask.';
                    walletStatus.className = 'status error';
                }
            } catch (error) {
                console.error('Connection error:', error);
                walletStatus.textContent = `Connection error: ${error.message}`;
                walletStatus.className = 'status error';
                transactionLoader.style.display = 'none';
            }
        });
        
        // Purchase credits
        purchaseCreditsBtn.addEventListener('click', async () => {
            try {
                if (!contract) return;
                
                streamMessage.style.display = 'block';
                streamMessage.textContent = 'Purchasing credits...';
                streamMessage.className = 'status info';
                transactionLoader.style.display = 'block';
                
                // Send 0.01 ETH to purchase credits
                const tx = await contract.purchaseCredits({ value: ethers.utils.parseEther("0.01") });
                
                streamMessage.textContent = 'Transaction submitted. Waiting for confirmation...';
                
                // Wait for transaction to be mined
                await tx.wait();
                
                // Update credit balance
                await updateCreditBalance();
                
                streamMessage.textContent = 'Credits purchased successfully!';
                streamMessage.className = 'status success';
                transactionLoader.style.display = 'none';
                
                // Enable start stream button if balance > 0
                if (parseInt(creditBalance.textContent) > 0) {
                    startStreamBtn.disabled = false;
                }
            } catch (error) {
                console.error('Purchase error:', error);
                streamMessage.textContent = `Purchase error: ${error.message}`;
                streamMessage.className = 'status error';
                transactionLoader.style.display = 'none';
            }
        });
        
        // Start stream
        startStreamBtn.addEventListener('click', async () => {
            try {
                if (!contract) return;
                
                const contentId = document.getElementById('content-id').textContent;
                
                streamMessage.style.display = 'block';
                streamMessage.textContent = 'Starting stream...';
                streamMessage.className = 'status info';
                transactionLoader.style.display = 'block';
                
                // For demo purposes, we'll simulate the contract call
                let tx;
                try {
                    // Try calling the contract (will fail in demo)
                    tx = await contract.startStream(contentId);
                    await tx.wait();
                } catch (error) {
                    console.log('Using demo mode due to missing contract');
                    // Simulate successful transaction for demo
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                
                // Update UI
                streamStatus.textContent = 'Active';
                
                // Set expiry time (1 hour from now)
                streamExpiryTime = Math.floor(Date.now() / 1000) + 3600;
                
                // Start countdown timer
                startAccessTimer();
                
                // Update credit balance (simulate for demo)
                creditBalance.textContent = Math.max(0, parseInt(creditBalance.textContent || '0') - 1).toString();
                startStreamBtn.disabled = creditBalance.textContent === '0';
                
                // Load the video
                streamMessage.textContent = 'Loading video stream...';
                const content = videoLoader.getDemoContent(contentId);
                
                videoLoader.loadVideo(content.ipfsCid, (videoUrl, error) => {
                    // Show the video player
                    playerPlaceholder.style.display = 'none';
                    videoPlayer.style.display = 'block';
                    videoPlayer.src = videoUrl;
                    
                    streamMessage.textContent = error ? 
                        `Stream started with fallback video: ${error}` : 
                        'Stream started successfully!';
                    streamMessage.className = 'status success';
                    transactionLoader.style.display = 'none';
                });
            } catch (error) {
                console.error('Stream error:', error);
                streamMessage.textContent = `Stream error: ${error.message}`;
                streamMessage.className = 'status error';
                transactionLoader.style.display = 'none';
            }
        });
        
        // Check access
        checkAccessBtn.addEventListener('click', async () => {
            try {
                if (!contract || !userAddress) return;
                
                const contentId = document.getElementById('content-id').textContent;
                
                streamMessage.style.display = 'block';
                streamMessage.textContent = 'Checking access...';
                streamMessage.className = 'status info';
                transactionLoader.style.display = 'block';
                
                // For demo purposes, simulate the contract call
                let hasAccess = false;
                try {
                    // Try calling the contract (will fail in demo)
                    hasAccess = await contract.canStream(userAddress, contentId);
                } catch (error) {
                    console.log('Using demo mode due to missing contract');
                    // Simulate random access for demo
                    hasAccess = Math.random() > 0.5;
                }
                
                if (hasAccess) {
                    streamStatus.textContent = 'Active';
                    
                    // For demo purposes, just set a 1-hour timer from now
                    streamExpiryTime = Math.floor(Date.now() / 1000) + 3600;
                    
                    // Start countdown timer
                    startAccessTimer();
                    
                    // Load the video
                    const content = videoLoader.getDemoContent(contentId);
                    
                    videoLoader.loadVideo(content.ipfsCid, (videoUrl, error) => {
                        // Show the video player
                        playerPlaceholder.style.display = 'none';
                        videoPlayer.style.display = 'block';
                        videoPlayer.src = videoUrl;
                        
                        streamMessage.textContent = error ? 
                            `You have access to this stream! (${error})` : 
                            'You have access to this stream!';
                        streamMessage.className = 'status success';
                        transactionLoader.style.display = 'none';
                    });
                } else {
                    streamStatus.textContent = 'No access';
                    
                    // Hide video player
                    playerPlaceholder.style.display = 'flex';
                    videoPlayer.style.display = 'none';
                    
                    streamMessage.textContent = 'You do not have access to this stream.';
                    streamMessage.className = 'status error';
                    transactionLoader.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Check access error:', error);
                streamMessage.textContent = `Error checking access: ${error.message}`;
                streamMessage.className = 'status error';
                transactionLoader.style.display = 'none';
            }
        });
        
        // Helper function to update credit balance
        async function updateCreditBalance() {
            if (!contract || !userAddress) return;
            
            try {
                let balance;
                try {
                    // Try calling the contract (will fail in demo)
                    balance = await contract.balanceOf(userAddress);
                } catch (error) {
                    console.log('Using demo mode due to missing contract');
                    // Simulate random balance for demo
                    balance = { toString: () => '3' }; 
                }
                
                creditBalance.textContent = balance.toString();
                
                // Enable start stream button if balance > 0
                startStreamBtn.disabled = balance.toString() === '0';
            } catch (error) {
                console.error('Error fetching balance:', error);
            }
        }
        
        // Start access timer
        function startAccessTimer() {
            // Clear existing timer
            if (accessTimer) {
                clearInterval(accessTimer);
            }
            
            // Update time remaining immediately
            updateTimeRemaining();
            
            // Set interval to update every second
            accessTimer = setInterval(updateTimeRemaining, 1000);
        }
        
        // Update time remaining display
        function updateTimeRemaining() {
            const now = Math.floor(Date.now() / 1000);
            const remaining = streamExpiryTime - now;
            
            if (remaining <= 0) {
                clearInterval(accessTimer);
                timeRemaining.textContent = 'Expired';
                streamStatus.textContent = 'Expired';
                
                // Hide video player
                playerPlaceholder.style.display = 'flex';
                videoPlayer.style.display = 'none';
                unlockMessage.textContent = 'Stream access expired. Please purchase more credits.';
                
                return;
            }
            
            const hours = Math.floor(remaining / 3600);
            const minutes = Math.floor((remaining % 3600) / 60);
            const seconds = remaining % 60;
            
            timeRemaining.textContent = `${hours}h ${minutes}m ${seconds}s`;
        }
        
        // Initialize content details
        document.getElementById('content-title').textContent = `Demo Content: ${demoContent.title}`;
        document.getElementById('content-creator').textContent = `By: ${demoContent.creator}`;
        document.getElementById('content-id').textContent = 'content_001';
        
        // Add placeholder image
        playerPlaceholder.style.backgroundImage = `url('${demoContent.thumbnail}')`;
        playerPlaceholder.style.backgroundSize = 'cover';
        playerPlaceholder.style.backgroundPosition = 'center';
    </script>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Team MODSIAS | Demo Prototype</p>
            </div>
        </div>
    </footer>
</body>
</html>